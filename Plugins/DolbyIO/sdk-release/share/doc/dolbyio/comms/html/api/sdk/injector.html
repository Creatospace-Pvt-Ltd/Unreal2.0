<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Default Media Injector &mdash; C++ SDK 2.4.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Default Media Recorder" href="recorder.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> C++ SDK
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/run_time_deps.html">Run Time Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/supported_platforms.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coresdk.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media_io.html">Media IO API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../plugins.html">Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="recorder.html">Default Media Recorder</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Default Media Injector</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#passthrough-injector">Passthrough Injector</a></li>
<li class="toctree-l3"><a class="reference internal" href="#paced-injector">Paced Injector</a></li>
<li class="toctree-l3"><a class="reference internal" href="#media-injection-status">Media Injection Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#media-source-for-injector">Media Source for Injector</a></li>
<li class="toctree-l3"><a class="reference internal" href="#media-file-source-sample">Media File Source Sample</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">C++ SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../plugins.html">Plugins</a> &raquo;</li>
      <li>Default Media Injector</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/api/sdk/injector.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="default-media-injector">
<span id="default-injector"></span><h1>Default Media Injector<a class="headerlink" href="#default-media-injector" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Default Media Injector is considered to be in Beta phase on MacOS and Windows systems.</p>
</div>
<p>The Default Media Injector module provides two different types of injectors:</p>
<ul class="simple">
<li><p>A pass-through injector designed for streaming applications</p></li>
<li><p>A pacing injector designed for media file injecting applications</p></li>
</ul>
<p>Both types of injectors provide connections to <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">audio</span></code> and <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">video</span></code> sinks for the media
frames to be passed on to. Each of the injectors accepts <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">audio</span> <span class="pre">frames</span></code> and <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">video</span> <span class="pre">frames</span></code>.</p>
<p>The main difference between the two injectors is that the paced injector provides a pacing logic, so that it can queue audio and video frames before injecting them into a conference. The passthrough injector accepts the raw audio and video frames and directly relays them to the CoreSDK. Thus, the application is responsible for invoking the frame injection
interface quickly.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenclass: Cannot find file: C:\GitLab-Runner\builds\RRYYHPBd\0\voxeet\cpp\sdk\build_directory\docs\artifacts\xml\index.xml</p>
</div>
<section id="passthrough-injector">
<h2>Passthrough Injector<a class="headerlink" href="#passthrough-injector" title="Permalink to this heading"></a></h2>
<p>The Passthrough Injector acts as a proxy to the RTC Audio/Video sources. A Media Injection Source uses the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">audio</span></code>
and the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">video</span></code> methods to pass frames to the Passthrough Injector, which in turn relays these frames to the CoreSDK.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenclass: Cannot find file: C:\GitLab-Runner\builds\RRYYHPBd\0\voxeet\cpp\sdk\build_directory\docs\artifacts\xml\index.xml</p>
</div>
</section>
<section id="paced-injector">
<h2>Paced Injector<a class="headerlink" href="#paced-injector" title="Permalink to this heading"></a></h2>
<p>The Paced Injector ensures that an application provides media frames to the CoreSDK at desired intervals. This is useful for applications that read from media files and produce frames quite quickly. The Paced Injector provides audio to
the CoreSDK in intervals of 10ms and has a configurable option for the video frame interval that specifies how quickly video frames should be provided. The injector
provides frames at these intervals by temporarily storing audio and video in queues. These queues have a limited size; they can store up to 1 second of audio and 300-400ms of video. When the queues are filled, the thread
pushing to the queues is blocked until a free space is available. The Paced Injector also provides methods for managing the pace, such as starting and stopping the pacing threads, clearing the
queues, and setting the video frame interval. If media file injection is paused by the injection source, silence should be injected into the conference to avoid AV sync issues when resuming the injection.
The Paced Injector also provides a method for injecting silent audio frames in 10ms chunks into the conference.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenclass: Cannot find file: C:\GitLab-Runner\builds\RRYYHPBd\0\voxeet\cpp\sdk\build_directory\docs\artifacts\xml\index.xml</p>
</div>
</section>
<section id="media-injection-status">
<h2>Media Injection Status<a class="headerlink" href="#media-injection-status" title="Permalink to this heading"></a></h2>
<p>The Media Injection Status is a structure that depicts the status of the injector. It is passed to the application when the status changes.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenstruct: Cannot find file: C:\GitLab-Runner\builds\RRYYHPBd\0\voxeet\cpp\sdk\build_directory\docs\artifacts\xml\index.xml</p>
</div>
</section>
<section id="media-source-for-injector">
<h2>Media Source for Injector<a class="headerlink" href="#media-source-for-injector" title="Permalink to this heading"></a></h2>
<p>Neither of the default injectors provide infrastructure for capturing and decoding media. This is the application’s responsibility; once it has decoded media frames, it can pass them to either of the
aforementioned injectors. We have provided a sample library to showcase how to create a Media Injection Source. This sample library, called <a class="reference internal" href="#media-source-file"><span class="std std-ref">Media File Source Sample</span></a>, reads media from a mov/mp4 file
and using the Paced Injector injects the audio and video frames into the CoreSDK. This <a class="reference internal" href="#media-source-file"><span class="std std-ref">Media File Source Sample</span></a> library is utilized by the provided sample application to inject media files. The
<a class="reference internal" href="../../other/getting_started.html#getting-started-sample"><span class="std std-ref">Sample application</span></a> page describes how to get media injection running with the sample application. A brief overview of the library is provided <a class="reference internal" href="#media-source-file"><span class="std std-ref">below</span></a>.</p>
<p>The audio provided to the injector, contained by the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">audio</span> <span class="pre">frame</span></code>, should have the following specifications:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 23%" />
<col style="width: 47%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Codec</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Format</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PCM</p></td>
<td><p>10ms of data</p></td>
<td><p>s16_Int</p></td>
</tr>
</tbody>
</table>
<p>The CoreSDK expects these 10ms chunks of PCM audio to be provided every 10ms. The video frames provided to the Injector, contained in <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">video</span> <span class="pre">frames</span></code>, must be YUV
pixels.</p>
</section>
<section id="media-file-source-sample">
<span id="media-source-file"></span><h2>Media File Source Sample<a class="headerlink" href="#media-file-source-sample" title="Permalink to this heading"></a></h2>
<p>The Media Source File sample library is a simple library that makes use of LibAV to read, demux, and decode audio and video frames. The top-level entity of this class is
<strong>dolbyio::comms::sample::file_source</strong> that takes an instance of the Paced Injector and creates a capture thread that parses and decodes media. When a media frame is decoded, this entity pushes the frame to the Paced Injector.</p>
<p>The Media File Source sample library provides the ability to parse the following types of media files:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Container</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>MP4</p></td>
</tr>
<tr class="row-odd"><td><p>MOV</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The Media File Source sample is able to decode the following video and audio codecs:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 33%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Codec</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Sample/Pixel Format</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>AAC</p></td>
<td><p>Audio</p></td>
<td><p>float, planar</p></td>
</tr>
<tr class="row-odd"><td><p>H264</p></td>
<td><p>Video</p></td>
<td><p>YUV</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The library is included along with proper CMake file in the package under <strong>share/dolbyio/comms/sample/media_source/</strong> directory. A sample of the top-level object
of the Media Source File library is in the following files:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * This program is licensed by the accompanying &quot;license&quot; file. This file is</span>
<span class="cm"> * distributed &quot;AS IS&quot; AND WITHOUT WARRANTY OF ANY KIND WHATSOEVER, either</span>
<span class="cm"> * express or implied. See the License for the specific language governing</span>
<span class="cm"> * permissions and limitations under the License.</span>
<span class="cm"> *</span>
<span class="cm"> *                Copyright (C) 2022 by Dolby Laboratories.</span>
<span class="cm"> ***************************************************************************/</span><span class="w"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;dolbyio/comms/multimedia_streaming/injector.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;comms/sample/media_source/file/libav_wrapper/avcontext.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;comms/sample/media_source/file/source_context.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;comms/sample/media_source/file/utils/audio_buffer.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;comms/sample/media_source/file/utils/frame_pool.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;comms/sample/media_source/file/utils/media_frame.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;condition_variable&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">dolbyio</span><span class="o">::</span><span class="nn">comms</span><span class="o">::</span><span class="nn">sample</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">source_state</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">,</span><span class="w"> </span><span class="n">RESTARTED</span><span class="p">,</span><span class="w"> </span><span class="n">CONTINUE</span><span class="p">,</span><span class="w"> </span><span class="n">RESUMED</span><span class="p">,</span><span class="w"> </span><span class="n">PAUSED</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">file_source_status</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">capturing_audio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">capturing_video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">source_state</span><span class="w"> </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source_state</span><span class="o">::</span><span class="n">STOPPED</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">using</span><span class="w"> </span><span class="n">audio_pool_frame_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">frame_from_pool</span><span class="o">&lt;</span><span class="n">audio_buffer</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">using</span><span class="w"> </span><span class="n">video_pool_frame_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">frame_from_pool</span><span class="o">&lt;</span><span class="n">frame</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">file_source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">file_source</span><span class="o">&gt;</span><span class="w"> </span><span class="n">create</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="kt">bool</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="n">dolbyio</span><span class="o">::</span><span class="n">comms</span><span class="o">::</span><span class="n">plugin</span><span class="o">::</span><span class="n">injector_paced</span><span class="o">&amp;</span><span class="w"> </span><span class="n">injection</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">file_source_status</span><span class="o">&amp;</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">status_cb</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">file_source</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">comms</span><span class="o">::</span><span class="n">plugin</span><span class="o">::</span><span class="n">injector_paced</span><span class="o">&amp;</span><span class="w"> </span><span class="n">injector</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">file_source_status</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">status_cb</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">~</span><span class="n">file_source</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Public Interface</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">set_audio_capture</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">set_video_capture</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">seek</span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">pause</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">resume</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">loop_current_file</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">enables</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">play_new_file</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">add_file_playlist</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">file</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">start_capture</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">stop_capture</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">restart_capture</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">init_context</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">initialize_av_context</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">playlist_not_finished</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">wait_thread_stopped</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">queue_audio_frame</span><span class="p">(</span><span class="n">audio_pool_frame_ptr</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">queue_video_frame</span><span class="p">(</span><span class="n">video_pool_frame_ptr</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">allocate_audio_frame_pool</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">audio_pool_frame_ptr</span><span class="w"> </span><span class="nf">process_audio</span><span class="p">(</span><span class="n">audio_pool_frame_ptr</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">curr_buff</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="o">&amp;</span><span class="w"> </span><span class="n">aframe</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Managing the capturing thread</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">start_thread</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">thread_function</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">capture_loop</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">capture_loop_exited</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">dolbyio</span><span class="o">::</span><span class="n">comms</span><span class="o">::</span><span class="n">plugin</span><span class="o">::</span><span class="n">injector_paced</span><span class="o">&amp;</span><span class="w"> </span><span class="n">injector_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">frame_pool</span><span class="o">&lt;</span><span class="n">audio_buffer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">audio_pool_</span><span class="p">{};</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">frame_pool</span><span class="o">&lt;</span><span class="n">frame</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">video_pool_</span><span class="p">{};</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">libav_context</span><span class="o">&gt;</span><span class="w"> </span><span class="n">libav_context_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">file_state</span><span class="w"> </span><span class="n">file_state_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input_files_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">curr_file_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">capture_state</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">capture_audio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">capture_video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">running_silence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">looping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">capture_state</span><span class="w"> </span><span class="n">capture_state_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_state</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">start_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">exit_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">waiting_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">stopped_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">thread_state</span><span class="w"> </span><span class="n">thread_state_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">capture_lock_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="w"> </span><span class="n">capture_thread_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="w"> </span><span class="n">wait_to_start_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="w"> </span><span class="n">wait_to_stop_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">capture_executor_</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">file_source_status</span><span class="o">&amp;</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">source_status_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="p">};</span><span class="w">  </span><span class="c1">// namespace dolbyio::comms::sample</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/***************************************************************************</span>
<span class="cm"> * This program is licensed by the accompanying &quot;license&quot; file. This file is</span>
<span class="cm"> * distributed &quot;AS IS&quot; AND WITHOUT WARRANTY OF ANY KIND WHATSOEVER, either</span>
<span class="cm"> * express or implied. See the License for the specific language governing</span>
<span class="cm"> * permissions and limitations under the License.</span>
<span class="cm"> *</span>
<span class="cm"> *                Copyright (C) 2022 by Dolby Laboratories.</span>
<span class="cm"> ***************************************************************************/</span><span class="w"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;comms/sample/media_source/file/source_capture.h&quot;</span><span class="cp"></span>



<span class="k">namespace</span><span class="w"> </span><span class="nn">dolbyio</span><span class="o">::</span><span class="nn">comms</span><span class="o">::</span><span class="nn">sample</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">file_source</span><span class="o">&gt;</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="kt">bool</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">dolbyio</span><span class="o">::</span><span class="n">comms</span><span class="o">::</span><span class="n">plugin</span><span class="o">::</span><span class="n">injector_paced</span><span class="o">&amp;</span><span class="w"> </span><span class="n">injector</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">file_source_status</span><span class="o">&amp;</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">status_cb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">file_source</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">files</span><span class="p">),</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="n">injector</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">status_cb</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">file_source</span><span class="o">::</span><span class="n">file_source</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="kt">bool</span><span class="w"> </span><span class="n">loop</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">dolbyio</span><span class="o">::</span><span class="n">comms</span><span class="o">::</span><span class="n">plugin</span><span class="o">::</span><span class="n">injector_paced</span><span class="o">&amp;</span><span class="w"> </span><span class="n">injector</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">file_source_status</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">status_cb</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">injector_</span><span class="p">(</span><span class="n">injector</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="n">video_pool_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">frame_pool</span><span class="o">&lt;</span><span class="n">frame</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">[]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">frame</span><span class="p">());</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="p">[](</span><span class="n">frame</span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"> </span><span class="p">})),</span><span class="w"></span>
<span class="w">      </span><span class="n">input_files_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">files</span><span class="p">)),</span><span class="w"></span>
<span class="w">      </span><span class="n">curr_file_</span><span class="p">(</span><span class="n">input_files_</span><span class="p">.</span><span class="n">begin</span><span class="p">()),</span><span class="w"></span>
<span class="w">      </span><span class="n">capture_thread_</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if defined(__APPLE__)</span>
<span class="w">        </span><span class="n">pthread_setname_np</span><span class="p">(</span><span class="s">&quot;injection_capture&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#elif defined(__linux__)</span>
<span class="w">        </span><span class="n">pthread_setname_np</span><span class="p">(</span><span class="n">capture_thread_</span><span class="p">.</span><span class="n">native_handle</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;injection_capture&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">thread_function</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}),</span><span class="w"></span>
<span class="w">      </span><span class="n">capture_executor_</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">capture_loop</span><span class="p">();</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="w">      </span><span class="n">source_status_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">status_cb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_file_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">file_state_</span><span class="p">.</span><span class="n">new_file</span><span class="p">(</span><span class="o">*</span><span class="n">curr_file_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Warning: no media file provided, you must provide one before &quot;</span><span class="w"></span>
<span class="w">                 </span><span class="s">&quot;starting injection!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">looping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loop</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">file_source</span><span class="o">::~</span><span class="n">file_source</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">stop_capture</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running_silence</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">injector_</span><span class="p">.</span><span class="n">stop_audio_injection</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">clear_audio_queue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">clear_video_queue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">exit_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">wait_to_start_</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">capture_thread_</span><span class="p">.</span><span class="n">join</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Error: Joining capture_thread threw: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">audio_pool_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">video_pool_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">libav_context_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">set_audio_capture</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Audio state already set to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Enable&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Disable&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enable</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Audio set to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Stop &quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Capture!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">start_audio_injection</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">start_capture</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stop_capture</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">set_video_capture</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Video state already set to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Enable&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Disable&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enable</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Video set to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Stop &quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Capture!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">start_video_injection</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">start_capture</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stop_capture</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">seek</span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">set_next_seek_time</span><span class="p">(</span><span class="n">time</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to Seek, Capture State &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Not&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; Running!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">file_state_</span><span class="p">.</span><span class="n">seek</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">pause</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Pause Failed, Capture is Not Running!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">file_state_</span><span class="p">.</span><span class="n">pause</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wait_thread_stopped</span><span class="p">(</span><span class="n">lock</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running_silence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">start_audio_silence_injection</span><span class="p">(</span><span class="n">file_state_</span><span class="p">.</span><span class="n">audio</span><span class="p">.</span><span class="n">sample_rate_</span><span class="p">,</span><span class="w"> </span><span class="n">file_state_</span><span class="p">.</span><span class="n">audio</span><span class="p">.</span><span class="n">channels_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">resume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file_state_</span><span class="p">.</span><span class="n">state</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">PAUSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Resume Failed, Current state is not Paused!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Stop injecting silence into the conference</span>
<span class="w">  </span><span class="n">injector_</span><span class="p">.</span><span class="n">stop_audio_injection</span><span class="p">(</span><span class="nb">true</span><span class="w"> </span><span class="cm">/*force stoppage*/</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">start_audio_injection</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">start_video_injection</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running_silence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">start_thread</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">play_new_file</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Is our playlist empty</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">input_files_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">curr_file_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Check if the new file to play is already part of the playlist</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="n">curr_file_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// If it is not check if adding a new file will invalidate</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">input_files_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">capacity</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">input_files_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">last_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">prev</span><span class="p">(</span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">iter_swap</span><span class="p">(</span><span class="n">curr_file_</span><span class="p">,</span><span class="w"> </span><span class="n">last_iter</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">curr_file_</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">input_files_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">last_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">prev</span><span class="p">(</span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">curr_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">curr_iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">curr_iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">curr_iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">iter_swap</span><span class="p">(</span><span class="n">curr_iter</span><span class="p">,</span><span class="w"> </span><span class="n">last_iter</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">curr_file_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_iter</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">file_state_</span><span class="p">.</span><span class="n">new_file</span><span class="p">(</span><span class="o">*</span><span class="n">curr_file_</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">add_file_playlist</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Check if the playlist is empty</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">input_files_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">curr_file_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Check if the file is already part of the playlist</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">input_files_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">capacity</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">input_files_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">curr_file_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">input_files_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">curr_file_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">start_capture</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_state_</span><span class="p">.</span><span class="n">state</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">STOP</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">NEW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">initialize_av_context</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">PAUSE</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">start_thread</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">stop_capture</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Capture from media file is already stopped!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Still Capturing Audio! &quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Not Capturing Audio! &quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Still Capturing Video!&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Not Capturing Video!&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Stop and wait for the thread to reach conditional in thread_function</span>
<span class="w">  </span><span class="n">file_state_</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">wait_thread_stopped</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">restart_capture</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">init_context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">init_context</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">initialize_av_context</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">injector_</span><span class="p">.</span><span class="n">start_video_injection</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">injector_</span><span class="p">.</span><span class="n">start_audio_injection</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">playlist_not_finished</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">curr_file_</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">input_files_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">wait_thread_stopped</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">.</span><span class="n">owns_lock</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">waiting_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">wait_to_stop_</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">stopped_</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">waiting_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">initialize_av_context</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file_state_</span><span class="p">.</span><span class="n">name</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;There is no media file set to read from!&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">libav_context_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">libav_context</span><span class="o">&gt;</span><span class="p">(</span><span class="n">file_state_</span><span class="p">.</span><span class="n">name</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">create_decoder</span><span class="p">(</span><span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">create_decoder</span><span class="p">(</span><span class="n">AVMEDIA_TYPE_AUDIO</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">libav_context_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed for reason: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// If the format of the audio in file is different we need a new audio frame</span>
<span class="w">  </span><span class="c1">// pool.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file_state_</span><span class="p">.</span><span class="n">audio</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">(),</span><span class="w"> </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">()))</span><span class="w"></span>
<span class="w">    </span><span class="n">allocate_audio_frame_pool</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">file_state_</span><span class="p">.</span><span class="n">audio</span><span class="p">.</span><span class="n">settings</span><span class="p">(</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">(),</span><span class="w"> </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">frame_rate</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Frame rate num: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rate</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; den: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rate</span><span class="p">.</span><span class="n">den</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">injector_</span><span class="p">.</span><span class="n">set_video_frame_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">.</span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="p">.</span><span class="n">den</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">queue_audio_frame</span><span class="p">(</span><span class="n">audio_pool_frame_ptr</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">injector_</span><span class="p">.</span><span class="n">inject_audio_frame</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">audio_frame_impl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">value</span><span class="p">)));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">queue_video_frame</span><span class="p">(</span><span class="n">video_pool_frame_ptr</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">injector_</span><span class="p">.</span><span class="n">inject_video_frame</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">video_frame_impl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">value</span><span class="p">)));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">allocate_audio_frame_pool</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">audio_pool_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">frame_pool</span><span class="o">&lt;</span><span class="n">audio_buffer</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="mi">100</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="n">samples</span><span class="p">{</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">},</span><span class="w"> </span><span class="n">channels</span><span class="p">{</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">()},</span><span class="w"></span>
<span class="w">       </span><span class="n">sample_rate</span><span class="p">{</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">()}]()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">audio_buffer</span><span class="o">*</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">audio_buffer</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="n">sample_rate</span><span class="p">,</span><span class="w"> </span><span class="n">channels</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">default_delete</span><span class="o">&lt;</span><span class="n">audio_buffer</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// right now only f32lpp, handle other input formats for audio</span>
<span class="n">audio_pool_frame_ptr</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">process_audio</span><span class="p">(</span><span class="n">audio_pool_frame_ptr</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">curr_buff</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="o">&amp;</span><span class="w"> </span><span class="n">aframe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">curr_buff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Current audio buffer is null!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">aframe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;No AVFrame provided!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">curr_buff</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aframe</span><span class="o">-&gt;</span><span class="n">format</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AV_SAMPLE_FMT_FLTP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Currently only support AVFrame format Float Planar!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">curr_buff</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">channel_buffer</span><span class="p">[</span><span class="n">AV_NUM_DATA_POINTERS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">aframe</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">channel_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">aframe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">aframe</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_buff</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">queue_audio_frame</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">curr_buff</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">curr_buff</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">frame_from_pool</span><span class="o">&lt;</span><span class="n">audio_buffer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">audio_pool_</span><span class="o">-&gt;</span><span class="n">get_frame</span><span class="p">(),</span><span class="w"> </span><span class="o">*</span><span class="n">audio_pool_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                        </span><span class="p">[](</span><span class="n">audio_buffer</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span><span class="w"> </span><span class="p">}));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">aframe</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">curr_buff</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_buff</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">queue_audio_frame</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">curr_buff</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">curr_buff</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">frame_from_pool</span><span class="o">&lt;</span><span class="n">audio_buffer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">audio_pool_</span><span class="o">-&gt;</span><span class="n">get_frame</span><span class="p">(),</span><span class="w"> </span><span class="o">*</span><span class="n">audio_pool_</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                      </span><span class="p">[](</span><span class="n">audio_buffer</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span><span class="w"> </span><span class="p">}));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">curr_buff</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">thread_function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">thread_state_</span><span class="p">.</span><span class="n">exit_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Check if someone is waiting to be sure the thread has returned</span>
<span class="w">      </span><span class="c1">// to the stopped state.</span>
<span class="w">      </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">stopped_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread_state_</span><span class="p">.</span><span class="n">waiting_</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">wait_to_stop_</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="n">wait_to_start_</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">start_</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">exit_</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>

<span class="w">      </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">stopped_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread_state_</span><span class="p">.</span><span class="n">exit_</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">capture_executor_</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">start_thread</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">start_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">wait_to_start_</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* This is called on the capture_thread_ after it exits the loop. We check the</span>
<span class="cm"> * current status of the file and act accordingly.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">capture_loop_exited</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// If the capture loop exited on it&#39;s own check if we need to loop single</span>
<span class="w">  </span><span class="c1">// file, play next file in play list or just exit.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_state_</span><span class="p">.</span><span class="n">state</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">PLAYING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// If the file left capture loop in play state it means there are still</span>
<span class="w">    </span><span class="c1">// like frames on the queue, make sure to let them all be inejcted before</span>
<span class="w">    </span><span class="c1">// continuing.</span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">stop_audio_injection</span><span class="p">(</span><span class="nb">false</span><span class="w"> </span><span class="cm">/*wait all frames to be injected*/</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">stop_video_injection</span><span class="p">(</span><span class="nb">false</span><span class="w"> </span><span class="cm">/*wait all frames to be injected*/</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">looping</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restart_capture</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">playlist_not_finished</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Go to the next file and set it to start playing once we enter the</span>
<span class="w">      </span><span class="c1">// capture loop</span>
<span class="w">      </span><span class="o">++</span><span class="n">curr_file_</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">file_state_</span><span class="p">.</span><span class="n">new_file</span><span class="p">(</span><span class="o">*</span><span class="n">curr_file_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restart_capture</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">file_state_</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">libav_context_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_status_</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">source_status_</span><span class="p">(</span><span class="n">file_source_status</span><span class="p">{</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">source_state</span><span class="o">::</span><span class="n">STOPPED</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// If file is no longer in the play state stop the injection threads and</span>
<span class="w">    </span><span class="c1">// then act accordingly based on the file state</span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">stop_audio_injection</span><span class="p">(</span><span class="nb">true</span><span class="w"> </span><span class="cm">/*force stoppage*/</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">injector_</span><span class="p">.</span><span class="n">stop_video_injection</span><span class="p">(</span><span class="nb">true</span><span class="w"> </span><span class="cm">/*force stoppage*/</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">SEEK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">seek_set_time</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restart_capture</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">NEW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">injector_</span><span class="p">.</span><span class="n">clear_audio_queue</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">injector_</span><span class="p">.</span><span class="n">clear_video_queue</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restart_capture</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">STOP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">injector_</span><span class="p">.</span><span class="n">clear_audio_queue</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">injector_</span><span class="p">.</span><span class="n">clear_video_queue</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">libav_context_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">thread_state_</span><span class="p">.</span><span class="n">start_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restart</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">file_source</span><span class="o">::</span><span class="n">capture_loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">audio_pool_frame_ptr</span><span class="w"> </span><span class="nf">reference_audio_frame</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">frame_from_pool</span><span class="o">&lt;</span><span class="n">audio_buffer</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">audio_pool_</span><span class="o">-&gt;</span><span class="n">get_frame</span><span class="p">(),</span><span class="w"> </span><span class="o">*</span><span class="n">audio_pool_</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="n">audio_buffer</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span><span class="w"> </span><span class="p">}));</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">audio_read_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">frame</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">file_state_</span><span class="p">.</span><span class="n">playing</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">read_single_packet</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Check if the state of the file has changed externally</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">capture_lock_</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">file_state</span><span class="o">::</span><span class="n">state_change</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_state_</span><span class="p">.</span><span class="n">state</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">PLAYING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">file_state</span><span class="o">::</span><span class="n">PAUSE</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">packet_finished</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">packet_to_decoder</span><span class="p">(</span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_video</span><span class="p">,</span><span class="w"> </span><span class="n">capture_state_</span><span class="p">.</span><span class="n">capture_audio</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">is_video</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">vframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">video_pool_</span><span class="o">-&gt;</span><span class="n">get_frame</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">frame_from_decoder</span><span class="o">&lt;</span><span class="n">video</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vframe</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AVERROR_EOF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">video_pool_</span><span class="o">-&gt;</span><span class="n">return_frame</span><span class="p">(</span><span class="n">vframe</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vframe</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">format</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AV_PIX_FMT_YUV420P</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">video_pool_</span><span class="o">-&gt;</span><span class="n">return_frame</span><span class="p">(</span><span class="n">vframe</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Bad video frame format&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">queue_video_frame</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">frame_from_pool</span><span class="o">&lt;</span><span class="n">frame</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">vframe</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">video_pool_</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="n">frame</span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">f</span><span class="o">-&gt;</span><span class="n">unref</span><span class="p">();</span><span class="w"> </span><span class="p">}));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">is_audio</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">frame_from_decoder</span><span class="o">&lt;</span><span class="n">audio</span><span class="o">&gt;</span><span class="p">(</span><span class="n">audio_read_frame</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AVERROR_EOF</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="c1">// this will return the current audio frame that contains the packets</span>
<span class="w">          </span><span class="c1">// which are left over from last fillage</span>
<span class="w">          </span><span class="n">reference_audio_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process_audio</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">reference_audio_frame</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="n">audio_read_frame</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">audio_read_frame</span><span class="o">-&gt;</span><span class="n">unref</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">libav_context_</span><span class="o">-&gt;</span><span class="n">packet_finished</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// All capture_loop stack variables deleted before checking reason for exit</span>
<span class="w">  </span><span class="n">capture_loop_exited</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="p">};</span><span class="w">  </span><span class="c1">// namespace dolbyio::comms::sample</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="recorder.html" class="btn btn-neutral float-left" title="Default Media Recorder" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Dolby Laboratories.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>